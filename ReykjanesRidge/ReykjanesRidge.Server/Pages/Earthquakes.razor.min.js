import*as THREE from"/js/threejs/three.module.js";import{OrbitControls}from"/js/threejs/controls/OrbitControls.js";import{FBXLoader}from"/js/threejs/loaders/FBXLoader.js";import{CSS2DRenderer,CSS2DObject}from"/js/threejs/renderers/CSS2DRenderer.js";import{Interaction}from"/js/threejs/interaction/src/three.interaction.js";var clock,controls,camera,scene,renderer,labelRenderer,mixer,animations,iceland,interaction,container=document.getElementById("threejscontainer"),earthquakes=[];$(document).ready(function(){$(window).resize(function(){null!=renderer&&null!=camera&&(container.getBoundingClientRect(),renderer.setSize(window.innerWidth,window.innerHeight),labelRenderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix())})});const earthRadius=6371,cameraStartingPos=new THREE.Vector3(357,388,113),cameraStartingFocusPoint=new THREE.Vector3(30,-50,-20),magnitudeColors=["rgb(255, 255, 255)","rgb(0, 255, 0)","rgb(255, 255, 0)","rgb(255, 0, 0)"];function animate(){requestAnimationFrame(animate),renderer.render(scene,camera),labelRenderer.render(scene,camera)}function render(){var e=clock.getDelta();void 0!==mixer&&mixer.update(e),renderer.render(scene,camera),labelRenderer.render(scene,camera)}function loadFBX(e,a){(new FBXLoader).load("/models/iceland_flat_svg.fbx",function(e){e.scale.set(.4,.4,.4),e.position.setX(36),e.position.setZ(-20),e.rotation.y=Math.PI/180*-22.7,a.add(e),e.traverse(function(e){e.material&&(e.material=new THREE.MeshStandardMaterial({color:2500134,emissive:2500134,opacity:.1}))})})}function loadScene(){var e;container&&(scene=new THREE.Scene,(camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,5e3)).position.copy(cameraStartingPos),(renderer=new THREE.WebGLRenderer).setSize(window.innerWidth,window.innerHeight),(labelRenderer=new CSS2DRenderer).setSize(window.innerWidth,window.innerHeight),labelRenderer.domElement.style.position="absolute",labelRenderer.domElement.style.top="0px",interaction=new Interaction(labelRenderer,scene,camera),container.appendChild(renderer.domElement),container.appendChild(labelRenderer.domElement),loadFBX("/models/iceland_flat_svg.fbx",iceland=new THREE.Group),scene.add(iceland),e=new THREE.AmbientLight(16777215,.2),scene.add(e),e=new THREE.PointLight(16777215,.8),scene.add(camera),camera.add(e),(controls=new OrbitControls(camera,labelRenderer.domElement)).screenSpacePanning=!1,controls.minDistance=5,controls.maxDistance=3e3,controls.target.copy(cameraStartingFocusPoint),controls.update(),animate())}function AddEarthquake(e,a=!0){var r,t,n,i;if(Array.isArray(e))for(var o=0;o<e.length;o++)AddEarthquake(e[o],a);else null!=iceland&&(i=e.magnitude,r=new THREE.Color(magnitudeColors[Math.floor(i)]),i=new THREE.SphereGeometry(i/2,32,10),n=new THREE.MeshStandardMaterial({color:16777215}),i=new THREE.Mesh(i,n),n=GCStoCartesian(e.latitude,e.longitude),i.material.color.set(r),i.material.emissive.set(r),i.material.transparent=!0,i.material.opacity=.6,(t=new THREE.Group).position.copy(n),t.position.setY(-e.depth),t.add(i),t.visible=a,n=e.depth+.3*Math.random(),(i=DrawLine([new THREE.Vector3(0,0,0),new THREE.Vector3(0,n,0)])).material.color.set(r),i.material.emissive.set(r),i.material.transparent=!0,i.material.opacity=.2,t.add(i),(i=DrawCircle(e.magnitude/2)).rotation.x=-Math.PI/2,i.position.setY(n),i.material.color.set(r),i.material.emissive.set(r),i.material.transparent=!0,i.material.opacity=.5,t.add(i),t.layers.set(1),iceland.add(t),t.cursor="pointer",t.on("mouseover",e=>FocusEarthquake(e)),t.on("mouseout",e=>UnfocusEarthquake(e)),t.on("click",function(e){controls.target.copy(e.data.target.position)}),earthquakes[e.id]=t.id)}function AddLocation(e){if(Array.isArray(e))for(var a=0;a<e.length;a++)AddLocation(e[a]);else{var r=document.createElement("div"),t=(r.textContent=e.name,r.style.backgroundColor="transparent",r.style.color="rgb(255, 255, 255)",r.style.fontSize=e.fontSize.toString()+"px",GCStoCartesian(e.latitude,e.longitude)),r=new CSS2DObject(r);r.position.copy(t),r.position.setY(3.5),r.center.set(0,0),r.layers.set(0),iceland.add(r)}}function FocusEarthquake(e){e=e.data.target;e.userData.originalColor=e.children[0].material.color,e.userData.originalScale=e.scale,e.scale.setX(1.1),e.scale.setY(1.1),e.scale.setZ(1.1)}function UnfocusEarthquake(e){e=e.data.target;e.scale.setX(1),e.scale.setY(1),e.scale.setZ(1)}function DrawLine(e){var a=new THREE.MeshStandardMaterial({color:16777215}),e=(new THREE.BufferGeometry).setFromPoints(e);return new THREE.Line(e,a)}function DrawCircle(e,a=0){var e=new THREE.CircleGeometry(e,32),r=new THREE.MeshStandardMaterial({color:16776960});return new THREE.Mesh(e,r)}function GCStoCartesian(e,a,r=earthRadius){var e=(90-e)*(Math.PI/180),a=(a+180)*(Math.PI/180),t=-(r*Math.sin(e)*Math.cos(a))-2530,r=r*Math.sin(e)*Math.sin(a)-900;return new THREE.Vector3(t,0,r)}function hideEarthquake(e){if(Array.isArray(e))for(var a=0;a<e.length;a++){var r=e[a];scene.getObjectById(earthquakes[r],!0).visible=!1}else scene.getObjectById(earthquakes[e],!0).visible=!1}function showEarthquake(e){if(Array.isArray(e))for(var a=0;a<e.length;a++){var r=e[a];scene.getObjectById(earthquakes[r],!0).visible=!0}else scene.getObjectById(earthquakes[e],!0).visible=!0}function toggleSidebar(){$(".ui.sidebar").sidebar({transition:"overlay"}),$(".ui.sidebar").sidebar("toggle")}function Debug(){null!=camera&&(console.log("camera position: "),console.log(camera.position)),setTimeout(Debug,5e3)}function setCameraPosition(e,a,r){null!=camera&&(camera.position.x=e,camera.position.y=a,camera.position.z=r)}window.EarthquakeVisualizerJS={load:()=>{loadScene()},addEarthquake:(e,a)=>{AddEarthquake(e,a)},addLocation:e=>{AddLocation(e)},showEarthquake:e=>{showEarthquake(e)},hideEarthquake:e=>{hideEarthquake(e)},setCameraPos:(e,a,r)=>{setCameraPosition(e,a,r)},toggleSidebar:()=>{toggleSidebar()}};